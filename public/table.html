<html>
<header>
    <script src="//code.jquery.com/jquery-3.1.1.min.js" charset="utf-8"></script>

<style>
    table{
        border-collapse:collapse; 
        table-layout:fixed; 
        width:310px;
    }
      
    #list{
        position: absolute;
        right: 300px;
        top: 100px;
    }

    #getInfo{
        position: absolute;
        right: 300px;
        top:200px;
        display:none;
    }

    /*this is the main table contain all comparing information*/
    #table{
        position: absolute;
        right: 300px;
        top:100px;
        display: none;
        border-collapse:collapse; 
        table-layout:fixed; 
        width:310px;  
    }
    
    #table td {
        border:solid 1px #fab; 
        width:100px; 
        word-wrap:break-word;}
    
     
    #table tr {
        border:solid 1px #fab; 
        width:100px; 
        word-wrap:break-word;}
    
    ul{
        list-style-type: none;
    }
    
    #aform{
        display: none;
    }
</style>

</header>
<body>
  <h1>Compare</h1>
  <div id="compare"> </div>
  <form onsubmit="return false;" id = "form">
    Search:
    <input type='text' id="inputBox" placeholder="Enter Location">
    <input type='submit' onclick="populate();">
  </form>
  <button onclick=advanceForm()>Advance Search</button>
  <div id='aform' >
    <form onsubmit="return false;">
        <input type='text' id="location" placeholder="Enter Location">  Location <br><br>
        <input type='text' id="term" placeholder="Enter Term">  Term <br><br>
        <input type='text' id="price" placeholder="1 to 5">  Price <br><br>
        <select id='dropdown'>  
            <option value="best_match">Best Match</option>
            <option value="rating">Rating</option>
            <option value="review_count">Review Count</option>
            <option value="distance">Distance</option>
        </select>
        <p>Sort By</p>
        <button onclick=advanceSearch()>Submit</button>
    </form>
  </div>
  <form id = "storeList">
    </form>
  <div id = 'list'></div>
  
 <table id='table'></table>
<button id="getInfo" onclick="getReview()">Compare</button>     

</body>
<script>
var checkedValue = [] //stroed checked values
var idname = {} //dictionary matched id with name
var ids = []
var allSearchedInfo = {}
//var needInfo = [] //info needed for build comparing table

function advanceForm(){
    var search = document.getElementById('form')
    var form = document.getElementById('aform')
    console.log(form)
    
    if(search.style.display == 'none'){
        search.style.display = 'inline'
        form.style.display = 'none'
    }else{
        search.style.display = 'none'
        form.style.display = 'inline'
    }
} 
    
function advanceSearch() {
  //console.log("start")
  var loc = document.getElementById('location').value;
  var term = document.getElementById('term').value;
  var price = document.getElementById('price').value;
  var sort = document.getElementById('dropdown').value;
  console.log('Dropdown')
  console.log(sort)
  var req = new XMLHttpRequest();
  req.open('POST', '/advanceSearch', true);
  req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  req.onreadystatechange = function() {
    handleRes(req);
  }
  req.send(loc+ '/' + term + '/' + price + '/' + sort);
}


//search for completed information for business based on business id
function getReview(){
    if(ids.length>0){
        //console.log('getReview function start')
        var request = new XMLHttpRequest();
        request.open('POST', '/getReview', true);
        request.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
        request.onreadystatechange = function(){
            handleGetReview(request)
        }   
        request.send(ids)
    }  
}
    
function handleGetReview(req) {

  if( req.readyState !== XMLHttpRequest.DONE )
    return;
  if(req.status === 200)
     console.log('response')
     console.log(JSON.parse(req.responseText))
     var response = JSON.parse(req.responseText)
     var needInfo = []
     var review = []
     response.forEach(function(i){
         needInfo.push(i.business)
         review.push(i.review)
     })
     
     buildTable(needInfo, review)
}
 
    
//After getting replied from server side, this function build the table    
function buildTable(needInfo, review){
    console.log('needInfo')
    console.log(needInfo)
    var table = document.getElementById('table');
    table.innerHTML = ''
    table.style.display = 'inline'
    document.getElementById('getInfo').style.display = 'none'
    document.getElementById('list').style.display = 'none'
    /*if(needInfo.length>0){
        buiding(table, review)
    }*/
    buiding(table, needInfo, review)
}
    
//building the comparing table
function buiding(table, needInfo, review){
    var htmlStr = ' '
    htmlStr += '<tr><td> Name </td>'
    needInfo.forEach(function(bus){ 
        htmlStr += '<td>'+bus.name+ ' </td>'
    })
    htmlStr += '<tr><td> Category </td>'
    needInfo.forEach(function(bus){
        var cat = ''
        bus.categories.forEach(function(c){
            cat = cat + c.title + '; '
        })
        htmlStr += '<td>'+cat+ ' </td>'
    })
    htmlStr += '<tr><td> Location </td>'
    needInfo.forEach(function(bus){ 
        var address = bus.location.address1 + ', '
        address = address + bus.location.city + ', '
        address = address + bus.location.state + ', '
        address += bus.location.zip_code
        htmlStr += '<td>'+ address +'</td>'
    })
    htmlStr += '<tr><td> Phone </td>'
    needInfo.forEach(function(bus){ 
        htmlStr += '<td>'+bus.phone+ ' </td>'
    })
    htmlStr += '<tr><td> Is Open Now</td>'
    needInfo.forEach(function(bus){ 
        var hour = bus.hours
        if (hour === undefined){
            hour = 'not avaliable'
            htmlStr += '<td>'+ hour + ' </td>'
        }else{
            htmlStr += '<td>'+ hour[0].is_open_now + ' </td>'  
        }         
    })
    htmlStr += '<tr><td>Open Hours</td>'
    needInfo.forEach(function(bus){ 
        var hour = bus.hours
        if (hour === undefined){
            hour = 'not avaliable'
            htmlStr += '<td>'+ hour + ' </td>'
        }else{
            var m = hour[0].open[0]
            var t = hour[0].open[1]
            var w = hour[0].open[2]
            var tr = hour[0].open[3]
            var fr = hour[0].open[4]
            var st = hour[0].open[5]
            var sun = hour[0].open[6]
            if(m === undefined){
                htmlStr += '<td> Monday: Closed'
            }else{
                htmlStr += '<td> Monday: '+ hour[0].open[0].start.substring(0,2) + ':' + hour[0].open[0].start.substring(2,4)+ ' - '  + hour[0].open[0].end.substring(0,2) 
                + ':' + hour[0].open[0].end.substring(2,4) + '</br>'
            }
            if(t === undefined){
                htmlStr += 'Tuesday: Closed'
            }else{
                htmlStr += 'Tuesday: '+ hour[0].open[1].start.substring(0,2) + ':' + hour[0].open[1].start.substring(2,4)+ ' - '  + hour[0].open[1].end.substring(0,2) 
                + ':' + hour[0].open[1].end.substring(2,4) + '</br>'
            }
            if(w === undefined){
                htmlStr += 'Wednesday: Closed'
            }else{
                htmlStr += 'Wednesday: '+ hour[0].open[2].start.substring(0,2) + ':' + hour[0].open[2].start.substring(2,4)+ ' - '  + hour[0].open[2].end.substring(0,2) 
                + ':' + hour[0].open[2].end.substring(2,4) + '</br>'
            }
            if(tr === undefined){
                htmlStr += 'Thursday: Closed'
            }else{
                htmlStr += 'Thursday: '+ hour[0].open[3].start.substring(0,2) + ':' + hour[0].open[3].start.substring(2,4)+ ' - '  + hour[0].open[3].end.substring(0,2) 
                + ':' + hour[0].open[3].end.substring(2,4) + '</br>'
            }
            if(fr === undefined){
                htmlStr += 'Friday: Closed'
            }else{
                htmlStr += 'Friday: '+ hour[0].open[4].start.substring(0,2) + ':' + hour[0].open[4].start.substring(2,4)+ ' - '  + hour[0].open[4].end.substring(0,2) 
                + ':' + hour[0].open[4].end.substring(2,4) + '</br>'
            }
            if(st === undefined){
                htmlStr += 'Saturday: Closed'
            }else{
                htmlStr += 'Saturday: '+ hour[0].open[5].start.substring(0,2) + ':' + hour[0].open[5].start.substring(2,4)+ ' - '  + hour[0].open[5].end.substring(0,2) 
                + ':' + hour[0].open[5].end.substring(2,4) + '</br>'
            }
           if(sun === undefined){
                htmlStr += 'Sunday: Closed'
            }else{
                htmlStr += 'Sunday: '+ hour[0].open[6].start.substring(0,2) + ':' + hour[0].open[6].start.substring(2,4)+ ' - '  + hour[0].open[6].end.substring(0,2) 
                + ':' + hour[0].open[6].end.substring(2,4) + '</br>'
            }
            htmlStr += ' </ul></td>'  
        }         
    })
    
    htmlStr += '<tr><td> Price </td>'
    needInfo.forEach(function(bus){ 
        htmlStr += '<td>'+bus.price+ ' </td>'
    })
    htmlStr += '<tr><td> Is Closed </td>'
    needInfo.forEach(function(bus){ 
        htmlStr += '<td>'+bus.is_closed+ ' </td>'
    })
    htmlStr += '<tr><td> Rating </td>'
    needInfo.forEach(function(bus){ 
        htmlStr += '<td>'+bus.rating+ ' </td>'
    })
    htmlStr += '<tr><td> Review Count </td>'
    needInfo.forEach(function(bus){ 
        htmlStr += '<td>'+bus.review_count+ ' </td>'
    })
    htmlStr += '<tr><td> Website </td>'
    needInfo.forEach(function(bus){ 
        htmlStr += '<td><a href="'+bus.url+ '">Enter</a> </td>'
    }) 
    htmlStr += '<tr><td> Review </td>'
    for(var i = 0; i < needInfo.length; i++){ 
        var text = review[i].reviews[0].text
        if (text === undefined){
            text = ' '
        }
        htmlStr += '<td>'+text +'</td>'
    }
    htmlStr += '<tr><td>  </td>'
    for(var i = 0; i < needInfo.length; i++){ 
        var text = review[i].reviews[1].text
        if (text === undefined){
            text = ' '
        }
        htmlStr += '<td>'+text +'</td>'
    }
    htmlStr += '<tr><td>  </td>'
    for(var i = 0; i < needInfo.length; i++){    
        var text = review[i].reviews[2].text
        if (text === undefined){
            text = ' '
        }
        htmlStr += '<td>'+text +'</td>'
    }

    
   // review.reviews.forEach(function(r){
    //    htmlStr += '<td>'+r.text +'</td>'
    //})
    //console.log(htmlStr)
    table.innerHTML = htmlStr
}


//get id and add to comparing list
function getname(){
    checkedValue = []
    idname = {}
    ids = []
    needInfo = []
    $('.store:checked').each(function(i){
        checkedValue[i] = $(this).val();
    })
    if (checkedValue.length > 5){
        alert("Choose at most five stores")
        return
    }
    for(var i = 0; i< checkedValue.length; i++){
        var str = checkedValue[i].split('/');
        idname[str[0]] = str[1]
    }
        console.log(idname)
        var table = document.getElementById('list');
        table.innerHTML = '';
        for(var key in idname){
            ids.push(key)
            needInfo.push(allSearchedInfo[key])
            table.innerHTML += '<p class="needsearch" value="'+key+'">' + idname[key] + '</p>'
        }
        document.getElementById('getInfo').style.display = 'inline'
        console.log(ids)

}

//search based on user entered information to get simple information
function populate() {
  //console.log("start")
  var el = document.getElementById('inputBox').value;
  console.log(el)
  //var el = "+14159083801"
  var req = new XMLHttpRequest();
  req.open('POST', '/search', true);
  req.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');
  req.onreadystatechange = function() {
    handleRes(req);
  }
  req.send(el);
}

function handleRes(req) {
  if( req.readyState !== XMLHttpRequest.DONE )
    return;

  if(req.status === 200)
    buildList( JSON.parse(req.responseText) );
}

function buildList( A ) {
  tableInfo = {}
  //number of elements in json file
  var number = A.total
  //constructs an array to hold elements
  tempInfo = A.businesses
  //console.log(A.businesses)
  var el = document.getElementById('storeList');
  el.innerHTML = "";
  tempInfo.forEach(function(e){
      allSearchedInfo[e.id] = e
      //console.log(e.name)
      el.innerHTML +=  '<label><input type="checkbox" value="'+ e.id + '/' + e.name + '"  class="store">'+e.name+'</label>'
      el.innerHTML += '<br>'
  })
  el.innerHTML+='<button type="button" onclick="getname()">Add to Compare List</button>'
}

</script>

</html>
